<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="Hugo 0.20.1" />
    <link rel="shortcut icon" href="/images/favicon.ico">
    <link href="http://yantonov.com/index.xml" rel="alternate" type="application/rss+xml" title="(map solve problems)" />
    
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css">
    
    <script src="https://apis.google.com/js/platform.js" async defer>{lang: 'ja'}</script>
    
    <link rel="stylesheet" href="https://yandex.st/highlightjs/8.0/styles/default.min.css">
    <script src="https://yandex.st/highlightjs/8.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    
    <link rel="stylesheet" type="text/css" href="/css/style.css">
    <title>Programmable completion for git and mercurial | (map solve problems)</title>
  </head>
  <body>
    <div id="wrap">
      
      <header class="site-header">
        <div class="site-header-left">
          <a class="site-header-title" href="http://yantonov.com/">(map solve problems)</a>
        </div>
      </header>
      <div class="container">
        <div id="main">

<div class="article">
  <header>
    <div class="article-header">
      <h1>Programmable completion for git and mercurial</h1>
      <div class="article-meta">
        <span class="posttime">2014/11/09</span>
        

      </div>
    </div>
    

  </header>
  <div class="content">
    <p>Some time ago i read excellent <a href="http://tsdh.wordpress.com/2013/05/31/eshell-completion-for-git-bzr-and-hg/">post</a> about emacs library <a href="http://www.emacswiki.org/emacs/ProgrammableCompletion">pcomplete</a>.</p>

<p>The author described implementation of completion for git, mercurial version control system using this library. Article is really usefull, i used code as is, its easy and provides all you need, but later i have some problem with it.</p>

<p>First problem - eager evaluation. General commands for git and mercurial are calculated once. Great, there is no reason to call external process like git or hg multiple times but precalculation occured at script evaluation. You may not want to start eshell, so call hg or git is not needed.</p>

<p>Second problem - if you broke PATH variable (emacs cant find git or hg executable, or you install emacs before you install git or mercurial) than you got crash while starting emacs (not fatal but annoying emacs lisp errors).</p>

<p>Thats why i add some modifications. I preserve &lsquo;precalculation&rsquo; of general command list for git and mercurial using this trivial snippet:</p>

<p>cache-defuns.el</p>

<pre><code class="language-lisp">(defun cached (f)
  &quot;evaluate once and cache it&quot;
  (lexical-let ((value nil)
                (fn f))
    (lambda (&amp;rest args)
      (if (eq value nil)
          (progn
            (setq value (funcall fn))
            value)
        value))))

(provide 'cache-defuns)
</code></pre>

<p>This snippet allow you to calculate function f once, and use its result at subsequent calls.</p>

<p>Another modifications connected with bad PATH variable. I dont throw exception or write message at emacs minibuffer but at time of completion corresponding error message will be printed at eshell instead of autocomplete results. Of course situation of broken PATH is not typical and occured very rarely so described solution works well.</p>

<p>Here you can find final code:</p>

<p>emacs-rc-pcomplete.el</p>

<pre><code class="language-lisp">;;**** Git Completion
(defun pcmpl-git-commands ()
  &quot;Return the most common git commands by parsing the git output.&quot;
  (interactive)
  (with-temp-buffer
    (call-process-shell-command &quot;git&quot; nil (current-buffer) nil &quot;help&quot; &quot;--all&quot;)
    (goto-char 0)
    (if (eq (search-forward &quot;available git commands in&quot;) nil)
        '(&quot;cant find git executable, check PATH varialbe&quot;)
      (let (commands)
        (while (re-search-forward
                &quot;^[[:blank:]]+\\([[:word:]-.]+\\)[[:blank:]]*\\([[:word:]-.]+\\)?&quot;
                nil t)
          (push (match-string 1) commands)
          (when (match-string 2)
            (push (match-string 2) commands)))
        (sort commands #'string&lt;)))))

(defconst cached__pcmpl-git-commands (cached 'pcmpl-git-commands)
  &quot;Cached list of `git' commands.&quot;)

(defvar pcmpl-git-ref-list-cmd &quot;git for-each-ref refs/ --format='%(refname)'&quot;
  &quot;The `git' command to run to get a list of refs.&quot;)

(defun pcmpl-git-get-refs (type)
  &quot;Return a list of `git' refs filtered by TYPE.&quot;
  (with-temp-buffer
    (insert (shell-command-to-string pcmpl-git-ref-list-cmd))
    (goto-char (point-min))
    (let (refs)
      (while (re-search-forward (concat &quot;^refs/&quot; type &quot;/\\(.+\\)$&quot;) nil t)
        (push (match-string 1) refs))
      (nreverse refs))))

(defun pcmpl-git-remotes ()
  &quot;Return a list of remote repositories.&quot;
  (split-string (shell-command-to-string &quot;git remote&quot;)))

(defun pcomplete/git ()
  &quot;Completion for `git'.&quot;
  ;; Completion for the command argument.
  (pcomplete-here* (funcall cached__pcmpl-git-commands))
  (cond
   ((pcomplete-match &quot;help&quot; 1)
    (pcomplete-here* (funcall cached__pcmpl-git-commands)))
   ((pcomplete-match (regexp-opt '(&quot;pull&quot; &quot;push&quot;)) 1)
    (pcomplete-here (pcmpl-git-remotes)))
   ;; provide branch completion for the command `checkout'.
   ((pcomplete-match &quot;checkout&quot; 1)
    (pcomplete-here* (append (pcmpl-git-get-refs &quot;heads&quot;)
                             (pcmpl-git-get-refs &quot;tags&quot;))))
   (t
    (while (pcomplete-here (pcomplete-entries))))))

;;**** Mercurial (hg) Completion

(defun pcmpl-hg-commands ()
  &quot;Return the most common hg commands by parsing the hg output.&quot;
  (interactive)
  (with-temp-buffer
    (call-process-shell-command &quot;hg&quot; nil (current-buffer) nil &quot;-v&quot; &quot;help&quot;)
    (goto-char 0)
    (if (eq (search-forward &quot;list of comxmands:&quot; nil t) nil)
        '(&quot;cant find hg executable, check PATH variable&quot;)
      (let (commands
            (bound (save-excursion
                     (re-search-forward &quot;^[[:alpha:]]&quot;)
                     (forward-line 0)
                     (point))))
        (while (re-search-forward
                &quot;^[[:blank:]]\\([[:word:]]+\\(?:, [[:word:]]+\\)*\\)&quot; bound t)
          (let ((match (match-string 1)))
            (if (not (string-match &quot;,&quot; match))
                (push (match-string 1) commands)
              (dolist (c (split-string match &quot;, ?&quot;))
                (push c commands)))))
        (sort commands #'string&lt;)))))

(defconst cached__pcmpl-hg-commands (cached 'pcmpl-hg-commands))

(defun pcomplete/hg ()
  &quot;Completion for `hg'.&quot;
  ;; Completion for the command argument.
  (pcomplete-here* (funcall cached__pcmpl-hg-commands))
  (cond
   ((pcomplete-match &quot;help&quot; 1)
    (pcomplete-here* (funcall cached__pcmpl-hg-commands)))
   (t
    (while (pcomplete-here (pcomplete-entries))))))
(provide 'emacs-rc-pcomplete)
</code></pre>

<p>Thanks <a href="http://tsdh.wordpress.com/">tsdh</a> and <a href="http://www.masteringemacs.org/">masteringemacs</a> for excellent posts and great explanation of emacs tricks. Recommend you to read this awesome blogs.</p>

  </div>
  <footer>
    <div class="article-footer">
      

      
      

      <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'yantonov';
    var disqus_identifier = 'http:\/\/yantonov.com\/blog\/2014\/11\/09\/programmable-completion-for-git-and-mercurial\/';
    var disqus_title = 'Programmable completion for git and mercurial';
    var disqus_url = 'http:\/\/yantonov.com\/blog\/2014\/11\/09\/programmable-completion-for-git-and-mercurial\/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
      
      <div id="pagenavigation-next-prev">
        
        <div id="pagenavigation-next">
          <span class="pagenav-label">Previous</span>
          <a href="http://yantonov.com/blog/2014/11/04/path-variable-for-gui-programs-mac-os/">PATH variable for gui programs (Mac Os)</a>
        </div>
        
        
        <div id="pagenavigation-prev">
          <span class="pagenav-label">Next</span>
          <a href="http://yantonov.com/blog/2014/11/13/church-numerals/">Church numerals</a>
        </div>
        
      </div>
      
    </div>
  </footer>
</div>
        </div>
        <div class="sidebar">
  
  
  <div class="sidebar-content">
    <div class="sidebar-header">
      <span>Author</span>
    </div>
    <div id="author">
      <span>Yury Antonov</span>
      <div>
        
        <a href="https://twitter.com/yantonov"><i class="fa fa-twitter-square fa-2x" aria-hidden="true"></i></a>
        
        
        <a href="https://github.com/yantonov"><i class="fa fa-github-square fa-2x" aria-hidden="true"></i></a>
        
        
        
      </div>
    </div>
  </div>
  
    <div class="sidebar-content">
    <div class="sidebar-header">
      <span>RSS</span>
    </div>
    <div id="rss">
      <a href="http://yantonov.com/index.xml" type="application/rss+xml" target="_blank">
        <i class="fa fa-rss-square fa-2x" aria-hidden="true"></i>
      </a>
    </div>
  </div>
  
  <div class="sidebar-content">
    <div class="sidebar-header">
      <span>Categories</span>
    </div>
    <div class="categories">
      <ul>
        
        <li>
          <a href="/categories/.net"><span></span>.net (1)</a>
        </li>
        
        <li>
          <a href="/categories/ai"><span></span>ai (3)</a>
        </li>
        
        <li>
          <a href="/categories/algorithm"><span></span>algorithm (2)</a>
        </li>
        
        <li>
          <a href="/categories/alias"><span></span>alias (1)</a>
        </li>
        
        <li>
          <a href="/categories/angular"><span></span>angular (1)</a>
        </li>
        
        <li>
          <a href="/categories/automation"><span></span>automation (2)</a>
        </li>
        
        <li>
          <a href="/categories/blog"><span></span>blog (1)</a>
        </li>
        
        <li>
          <a href="/categories/bookmark"><span></span>bookmark (2)</a>
        </li>
        
        <li>
          <a href="/categories/bookmarks"><span></span>bookmarks (1)</a>
        </li>
        
        <li>
          <a href="/categories/build"><span></span>build (1)</a>
        </li>
        
        <li>
          <a href="/categories/cache"><span></span>cache (2)</a>
        </li>
        
        <li>
          <a href="/categories/caching"><span></span>caching (1)</a>
        </li>
        
        <li>
          <a href="/categories/church-numerals"><span></span>church-numerals (1)</a>
        </li>
        
        <li>
          <a href="/categories/clojure"><span></span>clojure (1)</a>
        </li>
        
        <li>
          <a href="/categories/cmd"><span></span>cmd (1)</a>
        </li>
        
        <li>
          <a href="/categories/conditional"><span></span>conditional (1)</a>
        </li>
        
        <li>
          <a href="/categories/config"><span></span>config (1)</a>
        </li>
        
        <li>
          <a href="/categories/conflict-free-replicated-data-types"><span></span>conflict-free-replicated-data-types (1)</a>
        </li>
        
        <li>
          <a href="/categories/connection"><span></span>connection (1)</a>
        </li>
        
        <li>
          <a href="/categories/consensus"><span></span>consensus (1)</a>
        </li>
        
        <li>
          <a href="/categories/course"><span></span>course (1)</a>
        </li>
        
        <li>
          <a href="/categories/cproj"><span></span>cproj (1)</a>
        </li>
        
        <li>
          <a href="/categories/crdt"><span></span>crdt (1)</a>
        </li>
        
        <li>
          <a href="/categories/cs"><span></span>cs (1)</a>
        </li>
        
        <li>
          <a href="/categories/css"><span></span>css (1)</a>
        </li>
        
        <li>
          <a href="/categories/data-structures"><span></span>data-structures (1)</a>
        </li>
        
        <li>
          <a href="/categories/deep-learning"><span></span>deep-learning (1)</a>
        </li>
        
        <li>
          <a href="/categories/delete-package"><span></span>delete-package (1)</a>
        </li>
        
        <li>
          <a href="/categories/distributed-systems"><span></span>distributed-systems (1)</a>
        </li>
        
        <li>
          <a href="/categories/dvcs"><span></span>dvcs (2)</a>
        </li>
        
        <li>
          <a href="/categories/emacs"><span></span>emacs (1)</a>
        </li>
        
        <li>
          <a href="/categories/emacs-lisp"><span></span>emacs-lisp (1)</a>
        </li>
        
        <li>
          <a href="/categories/encoding"><span></span>encoding (1)</a>
        </li>
        
        <li>
          <a href="/categories/environment"><span></span>environment (2)</a>
        </li>
        
        <li>
          <a href="/categories/eshell"><span></span>eshell (1)</a>
        </li>
        
        <li>
          <a href="/categories/export"><span></span>export (1)</a>
        </li>
        
        <li>
          <a href="/categories/feeds"><span></span>feeds (1)</a>
        </li>
        
        <li>
          <a href="/categories/filename"><span></span>filename (1)</a>
        </li>
        
        <li>
          <a href="/categories/fprog"><span></span>fprog (3)</a>
        </li>
        
        <li>
          <a href="/categories/fun"><span></span>fun (1)</a>
        </li>
        
        <li>
          <a href="/categories/functional-programming"><span></span>functional-programming (2)</a>
        </li>
        
        <li>
          <a href="/categories/functional-test"><span></span>functional-test (1)</a>
        </li>
        
        <li>
          <a href="/categories/git"><span></span>git (5)</a>
        </li>
        
        <li>
          <a href="/categories/golang"><span></span>golang (1)</a>
        </li>
        
        <li>
          <a href="/categories/haskell"><span></span>haskell (3)</a>
        </li>
        
        <li>
          <a href="/categories/headers"><span></span>headers (1)</a>
        </li>
        
        <li>
          <a href="/categories/health"><span></span>health (1)</a>
        </li>
        
        <li>
          <a href="/categories/healthy-programmer"><span></span>healthy-programmer (1)</a>
        </li>
        
        <li>
          <a href="/categories/http"><span></span>http (1)</a>
        </li>
        
        <li>
          <a href="/categories/ide"><span></span>ide (1)</a>
        </li>
        
        <li>
          <a href="/categories/interview"><span></span>interview (1)</a>
        </li>
        
        <li>
          <a href="/categories/ios"><span></span>ios (1)</a>
        </li>
        
        <li>
          <a href="/categories/javascript"><span></span>javascript (1)</a>
        </li>
        
        <li>
          <a href="/categories/kalman-filter"><span></span>kalman-filter (1)</a>
        </li>
        
        <li>
          <a href="/categories/keyboard"><span></span>keyboard (1)</a>
        </li>
        
        <li>
          <a href="/categories/lambda-calculus"><span></span>lambda-calculus (1)</a>
        </li>
        
        <li>
          <a href="/categories/lambda_calculus"><span></span>lambda_calculus (1)</a>
        </li>
        
        <li>
          <a href="/categories/leiningen"><span></span>leiningen (1)</a>
        </li>
        
        <li>
          <a href="/categories/linked-list"><span></span>linked-list (1)</a>
        </li>
        
        <li>
          <a href="/categories/links"><span></span>links (1)</a>
        </li>
        
        <li>
          <a href="/categories/lisp"><span></span>lisp (2)</a>
        </li>
        
        <li>
          <a href="/categories/logic"><span></span>logic (1)</a>
        </li>
        
        <li>
          <a href="/categories/mac"><span></span>mac (4)</a>
        </li>
        
        <li>
          <a href="/categories/mac-os"><span></span>mac-os (2)</a>
        </li>
        
        <li>
          <a href="/categories/machine_learning"><span></span>machine_learning (2)</a>
        </li>
        
        <li>
          <a href="/categories/macos"><span></span>macos (1)</a>
        </li>
        
        <li>
          <a href="/categories/matplotlib"><span></span>matplotlib (1)</a>
        </li>
        
        <li>
          <a href="/categories/mercurial"><span></span>mercurial (3)</a>
        </li>
        
        <li>
          <a href="/categories/merge"><span></span>merge (1)</a>
        </li>
        
        <li>
          <a href="/categories/ml"><span></span>ml (3)</a>
        </li>
        
        <li>
          <a href="/categories/nautilus"><span></span>nautilus (1)</a>
        </li>
        
        <li>
          <a href="/categories/neural-network"><span></span>neural-network (1)</a>
        </li>
        
        <li>
          <a href="/categories/neural_network"><span></span>neural_network (1)</a>
        </li>
        
        <li>
          <a href="/categories/optimization"><span></span>optimization (1)</a>
        </li>
        
        <li>
          <a href="/categories/packages"><span></span>packages (1)</a>
        </li>
        
        <li>
          <a href="/categories/papers"><span></span>papers (1)</a>
        </li>
        
        <li>
          <a href="/categories/pcomplete"><span></span>pcomplete (1)</a>
        </li>
        
        <li>
          <a href="/categories/pkg"><span></span>pkg (1)</a>
        </li>
        
        <li>
          <a href="/categories/plugin"><span></span>plugin (1)</a>
        </li>
        
        <li>
          <a href="/categories/podcast"><span></span>podcast (1)</a>
        </li>
        
        <li>
          <a href="/categories/problem"><span></span>problem (2)</a>
        </li>
        
        <li>
          <a href="/categories/python"><span></span>python (1)</a>
        </li>
        
        <li>
          <a href="/categories/python3"><span></span>python3 (1)</a>
        </li>
        
        <li>
          <a href="/categories/raft"><span></span>raft (1)</a>
        </li>
        
        <li>
          <a href="/categories/react"><span></span>react (1)</a>
        </li>
        
        <li>
          <a href="/categories/repl"><span></span>repl (1)</a>
        </li>
        
        <li>
          <a href="/categories/rerere"><span></span>rerere (1)</a>
        </li>
        
        <li>
          <a href="/categories/review"><span></span>review (1)</a>
        </li>
        
        <li>
          <a href="/categories/rfc"><span></span>rfc (1)</a>
        </li>
        
        <li>
          <a href="/categories/rss"><span></span>rss (1)</a>
        </li>
        
        <li>
          <a href="/categories/scm"><span></span>scm (5)</a>
        </li>
        
        <li>
          <a href="/categories/script"><span></span>script (1)</a>
        </li>
        
        <li>
          <a href="/categories/shell"><span></span>shell (4)</a>
        </li>
        
        <li>
          <a href="/categories/shortcut"><span></span>shortcut (1)</a>
        </li>
        
        <li>
          <a href="/categories/site-generator"><span></span>site-generator (1)</a>
        </li>
        
        <li>
          <a href="/categories/sln"><span></span>sln (1)</a>
        </li>
        
        <li>
          <a href="/categories/sqlite"><span></span>sqlite (1)</a>
        </li>
        
        <li>
          <a href="/categories/stackoverflow"><span></span>stackoverflow (1)</a>
        </li>
        
        <li>
          <a href="/categories/static"><span></span>static (1)</a>
        </li>
        
        <li>
          <a href="/categories/static-site-generator"><span></span>static-site-generator (1)</a>
        </li>
        
        <li>
          <a href="/categories/task"><span></span>task (1)</a>
        </li>
        
        <li>
          <a href="/categories/test"><span></span>test (1)</a>
        </li>
        
        <li>
          <a href="/categories/tip"><span></span>tip (2)</a>
        </li>
        
        <li>
          <a href="/categories/trick"><span></span>trick (2)</a>
        </li>
        
        <li>
          <a href="/categories/turing-machine"><span></span>turing-machine (1)</a>
        </li>
        
        <li>
          <a href="/categories/ubuntu"><span></span>ubuntu (2)</a>
        </li>
        
        <li>
          <a href="/categories/ui"><span></span>ui (1)</a>
        </li>
        
        <li>
          <a href="/categories/usability"><span></span>usability (1)</a>
        </li>
        
        <li>
          <a href="/categories/user_experience"><span></span>user_experience (1)</a>
        </li>
        
        <li>
          <a href="/categories/ux"><span></span>ux (1)</a>
        </li>
        
        <li>
          <a href="/categories/vcs"><span></span>vcs (4)</a>
        </li>
        
        <li>
          <a href="/categories/vsc"><span></span>vsc (1)</a>
        </li>
        
        <li>
          <a href="/categories/wifi"><span></span>wifi (1)</a>
        </li>
        
        <li>
          <a href="/categories/workflow"><span></span>workflow (1)</a>
        </li>
        
        <li>
          <a href="/categories/xamarin"><span></span>xamarin (1)</a>
        </li>
        
      </ul>
    </div>
  </div>
  
</div>

      </div>
      <footer>
        <div id="site-footer-wrap">
          <div id="site-footer">
            <span>Powered by <a href="https://gohugo.io/">Hugo</a>.</span>
            <span>
              
              Copyright (c) 2017, <a href="http://yantonov.com/">(map solve problems)</a>
              
            </span>
          </div>
        </div>
      </footer>
    </div>
  </body>
</html>

